---
title: "Tidyr Soil"
author: "Apryl Perry, Clarice Perryman, Jochen Wirsing""
title: "Tidyr Soil"
author: "Apryl Perry"
date: "February 28, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Clear workspace (if desired/needed)
```{r}
rm(list = ls())
```

Load libraries
```{r}
library(tidyverse) #version 1.2.1
library(dplyr) #version 0.7.8
library(RCurl) #version 1.95.4.11
library(ggplot2) #version 3.1.0
library(reshape2) #version 1.4.3
library(agricolae)

#gets version numbers for packages installed in namespace, can reference to above version info for each package for reproducibility
print(paste("R", getRversion()))
print("-------------")
for (package_name in sort(loadedNamespaces())) {
    print(paste(package_name, packageVersion(package_name)))
}


```

Read in data file from Git, ignored first 4 rows - blank and or random file info, blank cells to NA
```{r}
downloadBSoil <- getURL("https://raw.githubusercontent.com/jagilman/Arctic-Ecol-Soc-2019/master/BestValue_Soil.csv") 
B_Soil <- read.csv(text = downloadBSoil, header = TRUE, skip = 4, na.strings = c(NA, ""))
```

Figure out which columns to remove/drop or expand 
Removed all columns ending with Sum, these are repeat info of existing columns. Create new df with only desired chemical species.  Add desired columns to chem database
```{r}
NoSum <- select (B_Soil, -c(ends_with('_Sum')))

USGS1 <- select(NoSum, matches('LAB_ID|FIELD_ID|DATE_SUBMITTED|DATE_COLLECT|LATITUDE|LONGITUDE|QUAD|SPHEROID|DATUM|DEPTH|SAMPLE_SOURCE|LOCATE_DESC|PRIMARY_CLASS|SAMPLE_COMMENT|SAMPLE_ZONE|HORIZON|ORGANICS|DRAINAGE|PREP|Hg_|Pb_|Ni_|As_|Cr_|Tl_'))


```

Filtering everything that has no info on the following:

* depth
* sample source

Then narrowed down columns.  

```{r latlon_depth}

USGS2 <- filter(USGS1, is.na(DEPTH) == FALSE)
USGS3 <- filter(USGS2, is.na(SAMPLE_SOURCE) == FALSE)
USGS4 <- select(USGS3,FIELD_ID, DATE_COLLECT, DEPTH, LOCATE_DESC, HORIZON, DATUM, LATITUDE, LONGITUDE, SAMPLE_SOURCE, As_ppm, As_ppm_AM, Cr_ppm, Cr_ppm_AM, Hg_ppm, Hg_ppm_AM, Ni_ppm, Ni_ppm_AM, Pb_ppm, Pb_ppm_AM) #dropped Tl - no data.

```

We need to wrangle the depths.... 
```{r}
#Recoding a chunk of depths to separate them correctly, removing non-numeric depths
USGS4$DEPTH <- recode(USGS4$DEPTH, "surface (0-25cm)"  = "0-25 cm")
USGS4$DEPTH <- recode(USGS4$DEPTH, "0- 5cm"  = "0-5 cm")#renaming several rows to get depth intervial
USGS4 <- filter(USGS4,!DEPTH  %in% c("unknown", "by horizon", "various", "A horizon", "B horizon", "C horizon", "surface", "Various", "loess", "loess ?")) 
##making units more consistent
USGS4$DEPTH<-str_replace(USGS4$DEPTH, "inches", "in")
USGS4$DEPTH<-str_replace(USGS4$DEPTH, "feet", "ft")
USGS4$DEPTH<-str_replace(USGS4$DEPTH, "'", " in")

#separate out units
USGS5 <- separate(USGS4, col="DEPTH", c("DEPTH", "UNIT"), sep = ' ')
#separate upper and lower units
USGS5 <- separate(USGS5, col="DEPTH", c("UPPPER", "LOWER"), sep = '-') %>% mutate_at(vars("UPPPER", "LOWER"), parse_number)

#remove bad split
USGS5 <- filter(USGS5, UNIT !="channel" )
#keep only rows with units
USGS5 <- filter(USGS5, UNIT %in% c("cm", "in", "ft"))


```

Now we need to convert units all to cm using a loop (probably)...work in progress...meanwhile I am going to do it offline so we can move forward. We can fix this part later - CP

```{r}
#write.csv(USGS5, file = "filtered_USGS.csv")

downloadUSGS <- getURL("https://raw.githubusercontent.com/jagilman/Arctic-Ecol-Soc-2019/master/filtered_USGS.csv")
USGS_analyze <- read.csv(text=downloadUSGS, header = T, na.strings = "")
USGS_analyze$As_ppm <- as.numeric(USGS_analyze$As_ppm)
USGS_analyze$Cr_ppm <- as.numeric(USGS_analyze$Cr_ppm)
USGS_analyze$Ni_ppm <- as.numeric(USGS_analyze$Ni_ppm)
USGS_analyze$Hg_ppm <- as.numeric(USGS_analyze$Hg_ppm)

#taking out sources with only 1 sample
USGS_analyze <- filter(USGS_analyze, SAMPLE_SOURCE !="float" ) #only one sample with this source
USGS_analyze <- filter(USGS_analyze, SAMPLE_SOURCE !="wetland/swamp/marsh/bog/fen" ) #only one sample with this source

#this removed values that are all the same within the same analytical method/sampling site
USGS_analyze$As_ppm<- na_if(USGS_analyze$As_ppm, 310)
USGS_analyze$Cr_ppm<- na_if(USGS_analyze$Cr_ppm, 266)
USGS_analyze$Hg_ppm<- na_if(USGS_analyze$Hg_ppm, 87)
USGS_analyze$Ni_ppm<- na_if(USGS_analyze$Ni_ppm, 292)
##Remove negative values from Pb column
is.na(USGS_analyze$Pb_ppm) <- USGS_analyze$Pb_ppm < 0
#USGS_analyze$Pb_ppm<- na_if(USGS_analyze$Pb_ppm, 3800.0)
USGS_analyze$Pb_log <- log10(USGS_analyze$Pb_ppm)

#Renaming SAMPLE_SOURCE as "Source" for better lengend title below
colnames(USGS_analyze)[colnames(USGS_analyze)=="SAMPLE_SOURCE"] <- "Source"

#Lumping samples sources together into broader categories
USGS_analyze$Source <- recode(USGS_analyze$Source, "mine tailings"  = "mine-impacted")
USGS_analyze$Source <- recode(USGS_analyze$Source, "mine dump/prospect pit"  = "mine-impacted")
USGS_analyze$Source <- recode(USGS_analyze$Source, "forest/scattered timberland"  = "forested")
USGS_analyze$Source <- recode(USGS_analyze$Source, "permafrost"  = "tundra")
USGS_analyze$Source <- recode(USGS_analyze$Source, "shrub covered"  = "tundra")
USGS_analyze$Source <- recode(USGS_analyze$Source, "grassland/grazing land/cultivated land"  = "tundra")
USGS_analyze$Source <- recode(USGS_analyze$Source, "tundra/alpine tundra"  = "tundra")
USGS_analyze$Source <- recode(USGS_analyze$Source, "glacial debris/deposit"  = "glacial deposit")
USGS_analyze$Source <- recode(USGS_analyze$Source, "surface"  = "sedge/moss/shrub wetland")

#This tells R to plot the depths in this order, not alphbetically. 
USGS_analyze$Depth <- factor(USGS_analyze$Depth, levels = c("surface", "mid", "deep"))

#source_depth_map <- write.csv(USGS_analyze, file="Map_data_5April2019")
```

Looking at distributions of metals data with basic boxplots, Cleveland dot plots, and histograms to look at distrubtions (commented out for now). 

```{r}
#boxplot(USGS_analyze$As_ppm)
#dotchart(USGS_analyze$As_ppm, xlab = "As (ppm)", xlim=c(-50,400), ylab = "Order of the data")
#hist(USGS_analyze$As_ppm)
#boxplot(USGS_analyze$As_ppm ~ USGS_analyze$SAMPLE_SOURCE)

#boxplot(USGS_analyze$Cr_ppm)
#dotchart(USGS_analyze$Cr_ppm, xlab = "Cr (ppm)", xlim=c(-50,400), ylab = "Order of the data")
#hist(USGS_analyze$Cr_ppm)

#boxplot(USGS_analyze$Hg_ppm)
#dotchart(USGS_analyze$Hg_ppm, xlab = "Hg (ppm)", xlim=c(-50,200), ylab = "Order of the data")
#hist(USGS_analyze$Hg_ppm) #lots of ones? and cluster of >80

#boxplot(USGS_analyze$Ni_ppm)
#dotchart(USGS_analyze$Ni_ppm, xlab = "Ni (ppm)", xlim=c(-50,400), ylab = "Order of the data")
#hist(USGS_analyze$Ni_ppm)


#boxplot(USGS_analyze$Pb_ppm)
#dotchart(USGS_analyze$Pb_ppm, xlab = "Pb (ppm)", xlim=c(-50,4000), ylab = "Order of the data") #one data point an order of magnitude higher than others....
#hist(USGS_analyze$Pb_ppm)
```


Making nicers box plots to look at concentration by sample source. Starting w/ As: 

```{r}
#get summary statistics for As concentrations
summary(USGS_analyze$As_ppm, na.rm=TRUE)
   #Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
    #1.0    35.0   131.0   136.2   228.0   309.0      68 
sd(USGS_analyze$As_ppm, na.rm=TRUE)
#stavard deviation is 100.4346

##Arsenic boxplot
As_plot <- ggplot(USGS_analyze, aes(Source, As_ppm, fill=Source)) + 
   geom_boxplot() +
  xlab("source") +
  ylab("As (mg/kg)") +
  theme_classic()+
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#Checking distribution for stats
shapiro.test(USGS_analyze$As_ppm) #tests for normality, p < 0.001
bartlett.test(As_ppm~Source, data=USGS_analyze) #tests for homogeneity of variance, p = 0.89

#Does log transforming help meet assumptions for ANOVA?
USGS_analyze$As_log <- log(USGS_analyze$As_ppm)
shapiro.test(USGS_analyze$As_log) #no, p < 0.001
bartlett.test(As_log~Source, data=USGS_analyze)#no, p  < 0.001

#using Kruskal-Wallis test in lieu of an ANOVA because of the lack of normality - this has a built in post hoc test using the criterium Fisher's least significant difference
As_bySource <- kruskal(USGS_analyze$As_ppm, USGS_analyze$Source, group=TRUE, p.adj = "bonferroni")
As_bySource #Chi-sq = 51.8, Df = 4, p < 0.001
#mine-impacted                            a
#sedge/moss/shrub wetland                 a
#glacial deposit                          a
#tundra                                   a
#forested                                 b

#Counts for annotation 
As_count <- select(USGS_analyze, Source, TOP_CM, Depth, As_ppm)
As_count<- filter(As_count, !is.na(As_ppm))
As_count %>% 
  group_by(Source) %>%
  summarise(no_rows = length(Source))


#adds correct colors, number of obs., lines for UK EA limit/US avg, and post-hoc groups
As_plot + scale_fill_manual(values=c("#b3de69", "#80b1d3", "#fdb462", "#fb8072", "#bebada")) + annotate("text", x = 1:5, y = -7, label = c("277", "82", "531", "19", "172")) + geom_hline(yintercept=32, linetype="dashed", size=1.25) + geom_hline(yintercept=7.2, linetype="dashed", size=1.25, color="darkgrey") + stat_summary(fun.y=mean, geom="point", shape=23, size=3, color="black", fill="white") +ylim(-10,320) + annotate("text", x = 1:5, y = 320, label = c("b", "a", "a", "a", "a"))
##Added a "limit" line in Black from the UK Environmental Agency (2009)


#plot by depth
As_depth <- ggplot(USGS_analyze, aes(Depth, As_ppm, fill=Depth)) + 
   geom_boxplot() +
  xlab("source") +
  ylab("As (mg/kg)") +
  theme_classic()+
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#Checking distribution for stats
shapiro.test(USGS_analyze$As_ppm) #tests for normality, p < 0.001
bartlett.test(As_ppm~Depth, data=USGS_analyze) #tests for homogeneity of variance, p = 0.46

#Does log transforming help meet assumptions for ANOVA?
shapiro.test(USGS_analyze$As_log) #no, p < 0.001
bartlett.test(As_log~Depth, data=USGS_analyze)#no, p  < 0.001

#using Kruskal-Wallis test in lieu of an ANOVA because of the lack of normality - this has a built in post hoc test using the criterium Fisher's least significant difference
As_byDepth <- kruskal(USGS_analyze$As_ppm, USGS_analyze$Depth, group=TRUE, p.adj = "bonferroni")
As_byDepth #Chi-sq = 11.01, Df = 2, p = 0.004
#mid         a
#surface     b
#deep        b


#Getting count by depth for annotating
As_count %>% 
  group_by(Depth) %>%
  summarise(no_rows = length(Depth))

#adds colors and labels
As_depth + scale_fill_manual(values=c("#fee0d2", "#fc9272", "#de2d26")) + geom_hline(yintercept=32, linetype="dashed", size=1.25) + annotate("text", x = 1:3, y = -7, label = c("843", "160", "78")) + geom_hline(yintercept=7.2, linetype="dashed", size=1.25, color="darkgrey") + geom_hline(yintercept=32, linetype="dashed", size=1.25) + stat_summary(fun.y=mean, geom="point", shape=23, size=3, color="black", fill="white") +ylim(-10,320) + annotate("text", x = 1:3, y = 320, label = c("b", "a", "b"))

```

Boxplots for Cr
```{r}
#get summary statistics for Cr concentrations
summary(USGS_analyze$Cr_ppm, na.rm=TRUE)
  #Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
    #1.0    87.0   135.0   133.2   187.0   265.0      68  
sd(USGS_analyze$Cr_ppm, na.rm=TRUE)
#stavard deviation is 67.29

##Chromium by source boxplot
Cr_plot <- ggplot(USGS_analyze, aes(Source, Cr_ppm, fill=Source)) + 
  geom_boxplot() +
  xlab("source") +
  ylab("Cr (mg/kg)") +
  theme_classic()+
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#Checking distribution for stats
shapiro.test(USGS_analyze$Cr_ppm) #tests for normality, p < 0.001
bartlett.test(Cr_ppm~Source, data=USGS_analyze) #tests for homogeneity of variance, p < 0.001

#Does log transforming help meet assumptions for ANOVA?
USGS_analyze$Cr_log <- log(USGS_analyze$Cr_ppm)
shapiro.test(USGS_analyze$Cr_log) #no, p < 0.001
bartlett.test(Cr_log~Source, data=USGS_analyze)#no, p  < 0.001

#using Kruskal-Wallis test in lieu of an ANOVA because of the lack of normality
Cr_bySource <- kruskal(USGS_analyze$Cr_ppm, USGS_analyze$Source, group=TRUE, p.adj = "bonferroni")
Cr_bySource #Chi-sq = 42.9, Df = 4, p < 0.001
#glacial deposit                           a
#sedge/moss/shrub wetland                  a
#mine-impacted                             ab
#forested                                  ab
#tundra                                    b

#Counts for annotation
Cr_count <- select(USGS_analyze, Source, TOP_CM, Depth, Cr_ppm)
Cr_count<- filter(Cr_count, !is.na(Cr_ppm))
Cr_count %>% 
  group_by(Source) %>%
  summarise(no_rows = length(Source))

#adds correct colors, number of obs., lines for WHO limit/US avg, and post-hoc groups
Cr_plot + scale_fill_manual(values=c("#b3de69", "#80b1d3", "#fdb462", "#fb8072", "#bebada")) + geom_hline(yintercept=100, linetype="dashed", size=1.25) + annotate("text", x = 1:5, y = -10, label = c("277", "82", "531", "19", "172")) + geom_hline(yintercept=37, linetype="dashed", size=1.25, color="darkgrey") + stat_summary(fun.y=mean, geom="point", shape=23, size=3, color="black", fill="white") + ylim(-10,300) + annotate("text", x = 1:5, y = 300, label = c("ab", "a", "b", "ab", "a"))
##Line values from WHO permissible limits for heavy metals in plant and soil (1996)


#plot by depth
Cr_depth <- ggplot(USGS_analyze, aes(Depth, Cr_ppm, fill=Depth)) + 
 geom_boxplot() +
  xlab("source") +
  ylab("Cr (mg/kg)") +
  theme_classic()+
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#Checking distribution for stats
shapiro.test(USGS_analyze$Cr_ppm) #tests for normality, p < 0.001
bartlett.test(Cr_ppm~Depth, data=USGS_analyze) #tests for homogeneity of variance, p = 0.004

#Does log transforming help meet assumptions for ANOVA?
shapiro.test(USGS_analyze$Cr_log) #no, p < 0.001
bartlett.test(Cr_log~Depth, data=USGS_analyze)#no, p  < 0.001

#using Kruskal-Wallis test in lieu of an ANOVA because of the lack of normality - this has a built in post hoc test using the criterium Fisher's least significant difference
Cr_byDepth <- kruskal(USGS_analyze$Cr_ppm, USGS_analyze$Depth, group=TRUE, p.adj = "bonferroni")
Cr_byDepth #Chi-sq = 40.1, Df = 2, p <0.001
#mid        a
#surface    b
#deep       c


#getting count for Depth
Cr_count %>% 
 group_by(Depth) %>%
  summarise(no_rows = length(Depth))

Cr_depth + scale_fill_manual(values=c("#fee6ce", "#fdae6b", "#e6550d")) + geom_hline(yintercept=100, linetype="dashed", size=1.25) + annotate("text", x = 1:3, y = -10, label = c("843", "160", "78"))+ geom_hline(yintercept=37, linetype="dashed", size=1.25, color="darkgrey") + stat_summary(fun.y=mean, geom="point", shape=23, size=3, color="black", fill="white") + ylim(-10,300) + annotate("text", x = 1:3, y = 300, label = c("ab", "a", "b"))


```


Boxplots for Hg
```{r}
#get summary statistics for Hg concentrations
summary(USGS_analyze$Hg_ppm, na.rm=TRUE)
   #Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
   #1.00    5.00    7.00   10.83    9.00   86.00     304  
sd(USGS_analyze$Hg_ppm, na.rm=TRUE)
#stavard deviation is 14.19

##Mercury by source boxplot
Hg_plot <- ggplot(USGS_analyze, aes(Source, Hg_ppm, fill=Source)) + 
  geom_boxplot() +
  xlab("source") +
  ylab("Hg (mg/kg)") +
  theme_classic()+
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#Checking distribution
shapiro.test(USGS_analyze$Hg_ppm) #tests for normality, p < 0.001
bartlett.test(Hg_ppm~Source, data=USGS_analyze) #tests for homogeneity of variance, p < 0.001

#Does log transforming help meet assumptions for ANOVA?
USGS_analyze$Hg_log <- log(USGS_analyze$Hg_ppm)
shapiro.test(USGS_analyze$Hg_log) #no, p < 0.001
bartlett.test(Hg_log~Source, data=USGS_analyze)#no, p  < 0.001


#using Kruskal-Wallis test in lieu of an ANOVA because of the lack of normality
Hg_bySource <- kruskal(USGS_analyze$Hg_ppm, USGS_analyze$Source, group=TRUE, p.adj = "bonferroni")
Hg_bySource #Chi-sq = 82.8, Df = 4, p < 0.001
#mine-impacted                             a
#glacial deposit                           b
#sedge/moss/shrub wetland                  c
#tundra                                    c
#forested                                  d

#Counts for annotation
Hg_count <- select(USGS_analyze, Source, Depth, TOP_CM, Hg_ppm)
Hg_count<- filter(Hg_count, !is.na(Hg_ppm))
Hg_count %>% 
  group_by(Source) %>%
  summarise(no_rows = length(Source))

#adds correct colors, number of obs., and post-hoc groups
Hg_plot + scale_fill_manual(values=c("#b3de69", "#80b1d3", "#fdb462", "#fb8072", "#bebada")) + annotate("text", x = 1:5, y = -10, label = c("139", "82", "440", "12", "172")) + stat_summary(fun.y=mean, geom="point", shape=23, size=3, color="black", fill="white") + ylim(-10,100) + annotate("text", x = 1:5, y = 100, label = c("d", "b", "c", "a", "c")) + geom_hline(yintercept=6.6, linetype="dashed", size=1.25)
#Standard from the Canadian Council of Ministers of the Environment

Hg_plot.log <- ggplot(USGS_analyze, aes(Source, Hg_log, fill=Source)) + 
  geom_boxplot() +
  xlab("source") +
  ylab("log [Hg (mg/kg)]") +
  theme_classic()+
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#adds correct colors, number of obs., and post-hoc groups
Hg_plot.log + scale_fill_manual(values=c("#b3de69", "#80b1d3", "#fdb462", "#fb8072", "#bebada")) + annotate("text", x = 1:5, y = -0.2, label = c("139", "82", "440", "12", "172")) + stat_summary(fun.y=mean, geom="point", shape=23, size=3, color="black", fill="white") + ylim(-.25,5) + annotate("text", x = 1:5, y = 5, label = c("d", "b", "c", "a", "c")) + geom_hline(yintercept=0.8195, linetype="dashed", size=1.25)
#Standard from the Canadian Council of Ministers of the Environment

#Checking distribution for stats
shapiro.test(USGS_analyze$Hg_ppm) #tests for normality, p < 0.001
bartlett.test(Hg_ppm~Depth, data=USGS_analyze) #tests for homogeneity of variance, p < 0.001

#Does log transforming help meet assumptions for ANOVA?
shapiro.test(USGS_analyze$Hg_log) #no, p < 0.001
bartlett.test(Hg_log~Depth, data=USGS_analyze)#no, p  < 0.001

#using Kruskal-Wallis test in lieu of an ANOVA because of the lack of normality - this has a built in post hoc test using the criterium Fisher's least significant difference
Hg_byDepth <- kruskal(USGS_analyze$Hg_ppm, USGS_analyze$Depth, group=TRUE, p.adj = "bonferroni")
Hg_byDepth #Chi-sq = 5.13, Df = 2, p = 0.0766
#deep       a
#mid        a
#surface    a

#getting depth counts
Hg_count %>% 
  group_by(Depth) %>%
  summarise(no_rows = length(Depth))

#plot by depth
Hg_depth <- ggplot(USGS_analyze, aes(Depth, Hg_log, fill=Depth)) + 
 geom_boxplot() +
xlab("source") +
  ylab("log [Hg (mg/kg)]") +
  theme_classic()+
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#adds correct colors and number of obs. 
Hg_depth + scale_fill_manual(values=c("#e5f5e0", "#a1d99b", "#31a354")) + annotate("text", x = 1:3, y = -0.2, label = c("628", "159", "58")) + stat_summary(fun.y=mean, geom="point", shape=23, size=3, color="black", fill="white") + ylim(-.25,5)


```


Boxplots for Ni
```{r}
#get summary statistics for Ni concentrations
summary(USGS_analyze$Ni_ppm, na.rm=TRUE)
  #Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
    #1.0    77.0   141.0   138.2   195.0   291.0      68  
sd(USGS_analyze$Ni_ppm, na.rm=TRUE)
#stavard deviation is 75.32

##Nickel by source boxplot
Ni_plot <- ggplot(USGS_analyze, aes(Source, Ni_ppm, fill=Source)) + 
  geom_boxplot() +
  xlab("source") +
  ylab("Ni (mg/kg)") +
  theme_classic()+ 
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#Checking distribution
shapiro.test(USGS_analyze$Ni_ppm) #tests for normality, p < 0.001
bartlett.test(Ni_ppm~Source, data=USGS_analyze) #tests for homogeneity of variance, p < 0.0002

#Does log transforming help meet assumptions for ANOVA?
USGS_analyze$Ni_log <- log(USGS_analyze$Ni_ppm)
shapiro.test(USGS_analyze$Ni_log) #no, p < 0.001
bartlett.test(Ni_log~Source, data=USGS_analyze)#no, p  < 0.001

#using Kruskal-Wallis test in lieu of an ANOVA because of the lack of normality
Ni_bySource <- kruskal(USGS_analyze$Ni_ppm, USGS_analyze$Source, group=TRUE, p.adj = "bonferroni")
Ni_bySource #Chi-sq = 74.01, Df = 4, p < 0.001
#mine-impacted                             a
#tundra                                    b
#forested                                 bc
#sedge/moss/shrub wetland                  c
#glacial deposit                           d

##gets counts for annotation
Ni_count <- select(USGS_analyze, Source, Depth, TOP_CM, Ni_ppm)
Ni_count<- filter(Ni_count, !is.na(Ni_ppm))
Ni_count %>% 
  group_by(Source) %>%
  summarise(no_rows = length(Source))

#adds correct colors, number of obs., lines for WHO limit/US avg, and post-hoc groups 
Ni_plot + scale_fill_manual(values=c("#b3de69", "#80b1d3", "#fdb462", "#fb8072", "#bebada")) + geom_hline(yintercept=35, linetype="dashed", size=1.25) + annotate("text", x = 1:5, y = -10, label = c("277", "82", "531", "19", "172")) + geom_hline(yintercept=40, linetype="dashed", size=1.25, color="darkgrey") + stat_summary(fun.y=mean, geom="point", shape=23, size=3, color="black", fill="white") + ylim(-10,300) + annotate("text", x = 1:5, y = 300, label = c("bc", "d", "b", "a", "c"))
##Line values from WHO permissible limits for heavy metals in plant and soil (1996)

#Checking distribution for stats
shapiro.test(USGS_analyze$Ni_ppm) #tests for normality, p < 0.001
bartlett.test(Ni_ppm~Depth, data=USGS_analyze) #tests for homogeneity of variance, p = 0.049

#Does log transforming help meet assumptions for ANOVA?
shapiro.test(USGS_analyze$Ni_log) #no, p < 0.001
bartlett.test(Ni_log~Depth, data=USGS_analyze) #no, p =.80

#using Kruskal-Wallis test in lieu of an ANOVA because of the lack of normality - this has a built in post hoc test using the criterium Fisher's least significant difference
Ni_byDepth <- kruskal(USGS_analyze$Ni_ppm, USGS_analyze$Depth, group=TRUE, p.adj = "bonferroni")
Ni_byDepth #Chi-sq = 11.73, Df = 2, p = 0.003
#surface         a
#mid             b
#deep            b

#getting depth count
Ni_count %>% 
  group_by(Depth) %>%
  summarise(no_rows = length(Depth))

#depth plot
Ni_depth <- ggplot(USGS_analyze, aes(Depth, Ni_ppm, fill=Depth)) + 
  geom_boxplot() +
  xlab("source") +
  ylab("Ni (mg/kg)") +
  theme_classic()+ 
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#adds correct colors and number of obs. 
Ni_depth + scale_fill_manual(values=c("#deebf7", "#9ecae1","#3182bd")) + geom_hline(yintercept=35, linetype="dashed", size=1.25) + annotate("text", x = 1:3, y = -10, label = c("843", "160", "78"))  + geom_hline(yintercept=40, linetype="dashed", size=1.25, color="darkgrey") + stat_summary(fun.y=mean, geom="point", shape=23, size=3, color="black", fill="white") + ylim(-10,300) + annotate("text", x = 1:3, y = 300, label = c("a", "b", "b"))

```


Boxplots for Pb
```{r}
#get summary statistics for Hg concentrations
summary(USGS_analyze$Pb_ppm, na.rm=TRUE)
    #Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
   #2.00    9.00   13.00   24.55   19.00 3800.00      69 
sd(USGS_analyze$Pb_ppm, na.rm=TRUE)
#stavard deviation is 122.13


##Lead by source boxplot
Pb_plot <- ggplot(USGS_analyze, aes(Source, Pb_log, fill=Source)) + 
   geom_boxplot() +
  xlab("source") +
  ylab("log [Pb (mg/kg)]") +
  theme_classic()+
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#Checking distrubition
shapiro.test(USGS_analyze$Pb_ppm) #tests for normality, p < 0.001
bartlett.test(Pb_ppm~Source, data=USGS_analyze) #tests for homogeneity of variance, p < 0.001

#Does log transforming help meet assumptions for ANOVA?
USGS_analyze$Pb_log <- log(USGS_analyze$Pb_ppm)
shapiro.test(USGS_analyze$Pb_log) #no, p < 0.001
bartlett.test(Pb_log~Source, data=USGS_analyze)#no, p  < 0.001

#using Kruskal-Wallis test in lieu of an ANOVA because of the lack of normality
Pb_bySource <- kruskal(USGS_analyze$Pb_ppm, USGS_analyze$Source, group=TRUE, p.adj = "bonferroni")
Pb_bySource #Chi-sq = 122.58, Df = 4, p < 0.001
#mine-impacted                             a
#forested                                  b
#tundra                                    b
#glacial deposit                           b
#sedge/moss/shrub wetland                  c

##getting counts for each source type to annotate figure 
Pb_count <- select(USGS_analyze, Source, Depth, TOP_CM, Pb_ppm, Pb_log)
Pb_count<- filter(Pb_count, !is.na(Pb_ppm))
Pb_count %>% 
  group_by(Source) %>%
  summarise(no_rows = length(Source))

#adds correct colors, number of obs., lines for WHO limit/US avg, and post-hoc groups 
Pb_plot + scale_fill_manual(values=c("#b3de69", "#80b1d3", "#fdb462", "#fb8072", "#bebada")) + geom_hline(yintercept=1.9294, linetype="dashed", size=1.25) + annotate("text", x = 1:5, y = 0, label = c("231", "82", "582", "19", "166"))  + geom_hline(yintercept=1.477, linetype="dashed", size=1.25, color="darkgrey") + stat_summary(fun.y=mean, geom="point", shape=23, size=3, color="black", fill="white") + ylim(0,3.25) + annotate("text", x = 1:5, y = 3.25, label = c("b", "b", "b", "a", "c"))
##Line values from WHO permissible limits for heavy metals in plant and soil (1996)

#Checking distribution for stats
shapiro.test(USGS_analyze$Pb_ppm) #tests for normality, p < 0.001
bartlett.test(Pb_ppm~Depth, data=USGS_analyze) #tests for homogeneity of variance, p < 0.001

#Does log transforming help meet assumptions for ANOVA?
shapiro.test(USGS_analyze$Pb_log) #no, p < 0.001
bartlett.test(Pb_log~Depth, data=USGS_analyze) #no, p < 0.001

#using Kruskal-Wallis test in lieu of an ANOVA because of the lack of normality - this has a built in post hoc test using the criterium Fisher's least significant difference
Pb_byDepth <- kruskal(USGS_analyze$Pb_ppm, USGS_analyze$Depth, group=TRUE, p.adj = "bonferroni")
Pb_byDepth #Chi-sq = 11.38, Df = 2, p = 0.003
#mid                a
#surface            b
#deep               b

#depth counts
Pb_count %>% 
  group_by(Depth) %>%
  summarise(no_rows = length(Depth))

#By depth
Pb_depth <- ggplot(USGS_analyze, aes(Depth, Pb_log, fill=Depth)) + 
   geom_boxplot() +
  xlab("source") +
  ylab("log [Pb (mg/kg)]") +
  theme_classic()+
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

Pb_depth

Pb_depth + scale_fill_manual(values=c("#efedf5", "#bcbddc","#756bb1")) + geom_hline(yintercept=1.9294, linetype="dashed", size=1.25) + annotate("text", x = 1:3, y = 0, label = c("843","159","78"))  + geom_hline(yintercept=1.477, linetype="dashed", size=1.25, color="darkgrey") + stat_summary(fun.y=mean, geom="point", shape=23, size=3, color="black", fill="white") + ylim(0,7) + annotate("text", x = 1:3, y = 7, label = c("b", "a", "b"))
##Line values from WHO permissible limits for heavy metals in plant and soil (1996)

```
Making figure for % over limits: 
```{r}

#Calculates the proportion of values greater than the UK Envi Agency As in soil limit (32 mg/kg)
mean(USGS_analyze$As_ppm > 32, na.rm=TRUE)
# returns 0.78
#Calculates the proportion of values greater than the US avg for As in soil from the Toxic Substances and Disease Registry (7.2 mg/kg)
mean(USGS_analyze$As_ppm > 7.2, na.rm=TRUE)
# returns 0.885

#Calculates the proportion of values greater than the WHO Cr in soil limit (100 mg/kg)
mean(USGS_analyze$Cr_ppm > 100, na.rm=TRUE)
# returns 0.6799
#Calculates the proportion of values greater than the US avg for Cr in soil from the Toxic Substances and Disease Registry (37 mg/kg)
mean(USGS_analyze$Cr_ppm > 37, na.rm=TRUE)
# returns 0.879

#Calculates the proportion of values greater than the Canadian Council of Ministers of the Environment Hg in soil limit (6.6 mg/kg)
mean(USGS_analyze$Hg_ppm > 6.6, na.rm=TRUE)
#returns 0.5479

#Calculates the proportion of values greater than the WHO Ni in soil limit (35 mg/kg)
mean(USGS_analyze$Ni_ppm > 35, na.rm=TRUE)
# returns 0.897
#Calculates the proportion of values greater than the US avg for Ni in soil from the Toxic Substances and Disease Registry (40 mg/kg)
mean(USGS_analyze$Ni_ppm > 40, na.rm=TRUE)
# returns 0.876

#Calculates the proportion of values greater than the WHO Pb in soil limit (85 mg/kg)
mean(USGS_analyze$Pb_ppm > 85, na.rm=TRUE)
# returns 0.029
#Calculates the proportion of values greater than the US avg for Pb in soil from the Toxic Substances and Disease Registry (30 mg/kg)
mean(USGS_analyze$Pb_ppm > 30, na.rm=TRUE)
# returns 0.1009

#making a plot
#creates a vector of the % of samples above health limits
limits <- c(mean(USGS_analyze$As_ppm > 32, na.rm=TRUE), mean(USGS_analyze$Cr_ppm > 100, na.rm=TRUE), mean(USGS_analyze$Hg_ppm > 6.6, na.rm=TRUE), mean(USGS_analyze$Ni_ppm > 35, na.rm=TRUE), mean(USGS_analyze$Pb_ppm > 85, na.rm=TRUE))

#making a dataframe to add metals names
limits <- as.data.frame(limits)
limits$metals <- c("As", "Cr", "Hg", "Ni", "Pb")
barplot(limits$limits)

#start working on plot here! 
ggplot(limits, aes(metals, limits, fill=metals)) +
  geom_col(
    aes(x = metals, ymin = 0, ymax = limits))+ ylim(0,1.0)+
    xlab("") +
  ylab("Proprtion Over Human Health Standard") +
  scale_fill_manual(values=c("#de2d26", "#e6550d","#31a354", "#3182bd","#756bb1"))+
  theme_classic()

```



Now...basic correlation plots of metals + lat/lon and depth
```{r}
USGS_numeric <- select(USGS_analyze,TOP_CM, LATITUDE, LONGITUDE, As_ppm, Cr_ppm, Hg_ppm, Ni_ppm, Pb_ppm) 

#creating a correlation matrix
cormat <- round(cor(USGS_numeric),2)
cormat

#"melting" the matrix (make longform)
melted_cormat <- melt(cormat)
head(melted_cormat)

#plot heatmap of correlation matrix
ggplot(data = melted_cormat, aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile()
```

Depth loop...still in process. 

```{r}
#Can't get this to work yet...I think something is wrong with the UPPER column? It says it's numeric...but it won't perform any mathematical operations on the column. 

#> USGS5$UPPER
#NULL
#> as.numeric(USGS5$UPPER)
#numeric(0)


###should work in theory...doesn't
converted <- mutate(USGS5, TOP = 
        ifelse(grepl("in", UNIT), USGS5$UPPER*2.54,
        ifelse(grepl("ft", UNIT), USGS5$UPPER*30.48, USGS5$UPPER*1))


###should work in theory...doesn't
USGS5$TOP <- ifelse(USGS5$UNIT %in% "in", USGS5$UPPER*2.54, USGS5$UPPER*1, 
ifelse(USGS5$UNIT %in% "ft", USGS5$UPPER*30.48, USGS5$UPPER*1))


```


