---
title: "Tidyr Soil"
author: "Apryl Perry, Clarice Perryman, Jochen Wirsing""
title: "Tidyr Soil"
author: "Apryl Perry"
date: "February 28, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Clear workspace (if desired/needed)
```{r}
rm(list = ls())
```

Load libraries
```{r}
library(tidyverse) #version 1.2.1
library(dplyr) #version 0.7.8
library(RCurl) #version 1.95.4.11
library(ggplot2) #version 3.1.0
library(reshape2) #version 1.4.3
library(agricolae)

#gets version numbers for packages installed in namespace, can reference to above version info for each package for reproducibility
print(paste("R", getRversion()))
print("-------------")
for (package_name in sort(loadedNamespaces())) {
    print(paste(package_name, packageVersion(package_name)))
}


```

Read in data file from Git, ignored first 4 rows - blank and or random file info, blank cells to NA
```{r}
downloadBSoil <- getURL("https://raw.githubusercontent.com/jagilman/Arctic-Ecol-Soc-2019/master/BestValue_Soil.csv") 
B_Soil <- read.csv(text = downloadBSoil, header = TRUE, skip = 4, na.strings = c(NA, ""))
```

Figure out which columns to remove/drop or expand 
Removed all columns ending with Sum, these are repeat info of existing columns. Create new df with only desired chemical species.  Add desired columns to chem database
```{r}
NoSum <- select (B_Soil, -c(ends_with('_Sum')))

USGS1 <- select(NoSum, matches('LAB_ID|FIELD_ID|DATE_SUBMITTED|DATE_COLLECT|LATITUDE|LONGITUDE|QUAD|SPHEROID|DATUM|DEPTH|SAMPLE_SOURCE|LOCATE_DESC|PRIMARY_CLASS|SAMPLE_COMMENT|SAMPLE_ZONE|HORIZON|ORGANICS|DRAINAGE|PREP|Hg_|Pb_|Ni_|As_|Cr_|Tl_'))


```

Filtering everything that has no info on the following:

* depth
* sample source

Then narrowed down columns.  

```{r latlon_depth}

USGS2 <- filter(USGS1, is.na(DEPTH) == FALSE)
USGS3 <- filter(USGS2, is.na(SAMPLE_SOURCE) == FALSE)
USGS4 <- select(USGS3,FIELD_ID, DATE_COLLECT, DEPTH, LOCATE_DESC, HORIZON, DATUM, LATITUDE, LONGITUDE, SAMPLE_SOURCE, As_ppm, As_ppm_AM, Cr_ppm, Cr_ppm_AM, Hg_ppm, Hg_ppm_AM, Ni_ppm, Ni_ppm_AM, Pb_ppm, Pb_ppm_AM) #dropped Tl - no data.

```

We need to wrangle the depths.... 
```{r}
#Recoding a chunk of depths to separate them correctly, removing non-numeric depths
USGS4$DEPTH <- recode(USGS4$DEPTH, "surface (0-25cm)"  = "0-25 cm")
USGS4$DEPTH <- recode(USGS4$DEPTH, "0- 5cm"  = "0-5 cm")#renaming several rows to get depth intervial
USGS4 <- filter(USGS4,!DEPTH  %in% c("unknown", "by horizon", "various", "A horizon", "B horizon", "C horizon", "surface", "Various", "loess", "loess ?")) 
##making units more consistent
USGS4$DEPTH<-str_replace(USGS4$DEPTH, "inches", "in")
USGS4$DEPTH<-str_replace(USGS4$DEPTH, "feet", "ft")
USGS4$DEPTH<-str_replace(USGS4$DEPTH, "'", " in")

#separate out units
USGS5 <- separate(USGS4, col="DEPTH", c("DEPTH", "UNIT"), sep = ' ')
#separate upper and lower units
USGS5 <- separate(USGS5, col="DEPTH", c("UPPPER", "LOWER"), sep = '-') %>% mutate_at(vars("UPPPER", "LOWER"), parse_number)

#remove bad split
USGS5 <- filter(USGS5, UNIT !="channel" )
#keep only rows with units
USGS5 <- filter(USGS5, UNIT %in% c("cm", "in", "ft"))

write.csv(USGS5, file = "filtered_USGS.csv")

```

Now we need to convert units all to cm using a loop (probably)...work in progress...meanwhile I am going to do it offline so we can move forward. We can fix this part later - CP

```{r}
##From CP - JE's comment about the high Hg values had me digging through to see if there were processing errors (units? order of mag errors?) - I found discrepancies between the copy of the filtered data on github and my local copy, so I reproccesed the data and created a new local copy. Working my new local copy of the filtered data right now instead of from git (hence some commented out code). 


USGS_analyze <- read.csv(file.choose())
#downloadUSGS <- getURL("https://raw.githubusercontent.com/jagilman/Arctic-Ecol-Soc-2019/master/filtered_USGS.csv")
#USGS_analyze <- read.csv(text=downloadUSGS, header = T, na.strings = "")
#USGS_analyze$As_ppm <- as.numeric(USGS_analyze$As_ppm)
#USGS_analyze$Cr_ppm <- as.numeric(USGS_analyze$Cr_ppm)
#USGS_analyze$Ni_ppm <- as.numeric(USGS_analyze$Ni_ppm)
#USGS_analyze$Hg_ppm <- as.numeric(USGS_analyze$Hg_ppm)


#replaced filtering/cleaning below with new version that's more efficient

#taking out values < 0
is.na(USGS_analyze$As_ppm) <- USGS_analyze$As_ppm < 0
is.na(USGS_analyze$Cr_ppm) <- USGS_analyze$Cr_ppm < 0
is.na(USGS_analyze$Hg_ppm) <- USGS_analyze$Hg_ppm < 0
is.na(USGS_analyze$Ni_ppm) <- USGS_analyze$Ni_ppm < 0
is.na(USGS_analyze$Pb_ppm) <- USGS_analyze$Pb_ppm < 0


#Renaming SAMPLE_SOURCE as "Source" for better lengend title below
colnames(USGS_analyze)[colnames(USGS_analyze)=="SAMPLE_SOURCE"] <- "Source"

#Lumping samples sources together into broader categories
USGS_analyze$Source <- recode(USGS_analyze$Source, "mine tailings"  = "mine-impacted")
USGS_analyze$Source <- recode(USGS_analyze$Source, "mine dump/prospect pit"  = "mine-impacted")
USGS_analyze$Source <- recode(USGS_analyze$Source, "forest/scattered timberland"  = "forested")
USGS_analyze$Source <- recode(USGS_analyze$Source, "permafrost"  = "tundra")
USGS_analyze$Source <- recode(USGS_analyze$Source, "shrub covered"  = "tundra")
USGS_analyze$Source <- recode(USGS_analyze$Source, "grassland/grazing land/cultivated land"  = "tundra")
USGS_analyze$Source <- recode(USGS_analyze$Source, "tundra/alpine tundra"  = "tundra")
USGS_analyze$Source <- recode(USGS_analyze$Source, "float"  = "glacial deposit")
USGS_analyze$Source <- recode(USGS_analyze$Source, "glacial debris/deposit"  = "glacial deposit")
USGS_analyze$Source <- recode(USGS_analyze$Source, "wetland/swamp/marsh/bog/fen"  = "sedge/moss/shrub wetland")
USGS_analyze$Source <- recode(USGS_analyze$Source, "surface"  = "sedge/moss/shrub wetland")

levels(USGS_analyze$Source)

#this removed values that are all the same within the same analytical method/sampling site
#15 May 2019 - CP: as I'm redoing the data processing I'm not seeing the concering repeat values we did previously...commenting these out
#USGS_analyze$As_ppm<- na_if(USGS_analyze$As_ppm, 310)
#USGS_analyze$Cr_ppm<- na_if(USGS_analyze$Cr_ppm, 266)
#USGS_analyze$Hg_ppm<- na_if(USGS_analyze$Hg_ppm, 87)
#USGS_analyze$Ni_ppm<- na_if(USGS_analyze$Ni_ppm, 292)

#This tells R to plot the depths in this order, not alphbetically. 
USGS_analyze$depth <- factor(USGS_analyze$Depth, levels = c("surface", "mid", "deep"))

```

Looking at distributions of metals data with basic boxplots, Cleveland dot plots, and histograms to look at distrubtions (commented out for now). 

```{r}
boxplot(USGS_analyze$As_ppm)
dotchart(USGS_analyze$As_ppm, xlab = "As (ppm)", ylab = "Order of the data")
hist(USGS_analyze$As_ppm)
boxplot(USGS_analyze$As_ppm ~ USGS_analyze$Source)
USGS_analyze$As_ppm<- na_if(USGS_analyze$As_ppm, 92000.0) 
#value of 92000.0 ppm is order of mag higher than others... 

boxplot(USGS_analyze$Cr_ppm)
dotchart(USGS_analyze$Cr_ppm, xlab = "Cr (ppm)",  ylab = "Order of the data")
hist(USGS_analyze$Cr_ppm)
boxplot(USGS_analyze$Cr_ppm ~ USGS_analyze$Source)

boxplot(USGS_analyze$Hg_ppm)
dotchart(USGS_analyze$Hg_ppm, xlab = "Hg (ppm)", ylab = "Order of the data")
hist(USGS_analyze$Hg_ppm) 
boxplot(USGS_analyze$Hg_ppm ~ USGS_analyze$Source)
USGS_analyze$Hg_ppm<- na_if(USGS_analyze$Hg_ppm, 46400.00) 
#value of 46400.00 ppm is order of mag higher than others... 

boxplot(USGS_analyze$Ni_ppm)
dotchart(USGS_analyze$Ni_ppm, xlab = "Ni (ppm)",ylab = "Order of the data")
hist(USGS_analyze$Ni_ppm)
boxplot(USGS_analyze$Ni_ppm ~ USGS_analyze$Source)

boxplot(USGS_analyze$Pb_ppm)
dotchart(USGS_analyze$Pb_ppm, xlab = "Pb (ppm)", ylab = "Order of the data") 
hist(USGS_analyze$Pb_ppm)
boxplot(USGS_analyze$Pb_ppm ~ USGS_analyze$Source)
USGS_analyze$Pb_ppm<- na_if(USGS_analyze$Pb_ppm, 3800.0) 
#value of 3800.0 ppm is order of mag higher than others...


#log (natural log) tranforming all metals data for display
USGS_analyze$As_log <- log(USGS_analyze$As_ppm)
USGS_analyze$Cr_log <- log(USGS_analyze$Cr_ppm)
USGS_analyze$Hg_log <- log(USGS_analyze$Hg_ppm)
USGS_analyze$Ni_log <- log(USGS_analyze$Ni_ppm)
USGS_analyze$Pb_log <- log(USGS_analyze$Pb_ppm)


```


Making nicers box plots to look at concentration by sample source. Starting w/ As: 

```{r}
#get summary statistics for As concentrations
summary(USGS_analyze$As_ppm, na.rm=TRUE)
   #Min.      1st Qu.  Median    Mean   3rd Qu.     Max.    NA's 
    #0.39     7.00    11.00   187.83    20.00   14900.00      190 
sd(USGS_analyze$As_ppm, na.rm=TRUE)
#stavard deviation is 1120.736


#Checking distribution for stats
shapiro.test(USGS_analyze$As_ppm) #tests for normality, p < 0.001
bartlett.test(As_ppm~Source, data=USGS_analyze) #tests for homogeneity of variance, p < 0.001

#Does log transforming help meet assumptions for ANOVA?
USGS_analyze$As_log <- log(USGS_analyze$As_ppm)
shapiro.test(USGS_analyze$As_log) #no, p < 0.001
bartlett.test(As_log~Source, data=USGS_analyze)#no, p  < 0.001

#using Kruskal-Wallis test in lieu of an ANOVA because of the lack of normality - this has a built in post hoc test using the criterium Fisher's least significant difference
As_bySource <- kruskal(USGS_analyze$As_ppm, USGS_analyze$Source, group=TRUE, p.adj = "bonferroni")
As_bySource #Chi-sq = 99.76, Df = 4, p < 0.001
#mine-impacted                       942.4444      a
#forested                            516.0399      b
#tundra                              497.6323      b
#glacial deposit                     496.4578      b
#sedge/moss/shrub wetland            339.5202      c

#Counts for annotation 
As_count <- select(USGS_analyze, Source, upper.cm, Depth, As_ppm)
As_count<- filter(As_count, !is.na(As_ppm))
As_count %>% 
  group_by(Source) %>%
  summarise(no_rows = length(Source))


##Arsenic boxplot
As_plot <- ggplot(USGS_analyze, aes(Source, As_log, fill=Source)) + 
   geom_boxplot() +
  xlab("source") +
  ylab("ln [As (mg/kg)]") +
  theme_classic()+
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#adds coded colors, number of obsverations, and post-hoc groups
As_plot +
  scale_fill_manual(values=c("#80b1d3", "#b3de69", "#fdb462", "#fb8072", "#bebada")) + 
  annotate("text", x = 1:5, y = -0.5, label = c("83", "188", "499", "18", "173")) +
  annotate("text", x = 1:5, y = 10, label = c("b", "b", "b", "a", "c"))
#Adds a health limit line in Black from the UK Environmental Agency (2009)
# + geom_hline(yintercept=3.4657, linetype="dashed", size=0.75)
#Adds a US average from the Toxic Substances and Disease Registry
# + geom_hline(yintercept=1.974, linetype="dotted", size=0.75, color="black")
# adds group means onto plot
# + stat_summary(fun.y=mean, geom="point", shape=23, size=3, color="black", fill="white") +ylim(-0.5,10)


#Checking distribution of depths for stats
bartlett.test(As_ppm~Depth, data=USGS_analyze) #tests for homogeneity of variance, p < 0.001

#Does log transforming help meet assumptions for ANOVA?
bartlett.test(As_log~Depth, data=USGS_analyze)#no, p  < 0.001

#using Kruskal-Wallis test in lieu of an ANOVA because of the lack of normality - this has a built in post hoc test using the criterium Fisher's least significant difference
As_byDepth <- kruskal(USGS_analyze$As_ppm, USGS_analyze$Depth, group=TRUE, p.adj = "bonferroni")
As_byDepth #Chi-sq = 5.996, Df = 2, p = 0.04986
#mid                531.0915      a
#surface            472.3721      a
#deep               463.8210      a


#Getting count by depth for annotating
As_count %>% 
  group_by(Depth) %>%
  summarise(no_rows = length(Depth))

#plot by depth
As_depth <- ggplot(USGS_analyze, aes(depth, As_log, fill=depth)) + 
   geom_boxplot() +
  xlab("source") +
  ylab("ln [As (mg/kg)]") +
  theme_classic()+
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())



#adds colors and labels
As_depth + 
  scale_fill_manual(values=c("#fee0d2", "#fc9272", "#de2d26"))+
  annotate("text", x = 1:3, y = -0.5, label = c("727", "153", "81"))+
  ylim(-0.5,10) + 
  annotate("text", x = 1:3, y = 10, label = c("b", "a", "b"))
#Adds a health limit line in Black from the UK Environmental Agency (2009)
# + geom_hline(yintercept=3.4657, linetype="dashed", size=0.75) 
#Adds a US average from the Toxic Substances and Disease Registry
#  + geom_hline(yintercept=1.974, linetype="dotted", size=0.75, color="black")
#Adds group means onto plot
#+ stat_summary(fun.y=mean, geom="point", shape=23, size=3, color="black", fill="white")

```

Boxplots for Cr
```{r}
#get summary statistics for Cr concentrations
summary(USGS_analyze$Cr_ppm, na.rm=TRUE)
  #Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
    #1.00   33.30   56.00   59.24   78.00  350.00      79  
sd(USGS_analyze$Cr_ppm, na.rm=TRUE)
#stavard deviation is 38.04351

#Checking distribution for stats
shapiro.test(USGS_analyze$Cr_ppm) #tests for normality, p < 0.001
bartlett.test(Cr_ppm~Source, data=USGS_analyze) #tests for homogeneity of variance, p < 0.001

#Does log transforming help meet assumptions for ANOVA?
shapiro.test(USGS_analyze$Cr_log) #no, p < 0.001
bartlett.test(Cr_log~Source, data=USGS_analyze)#no, p  < 0.001

#using Kruskal-Wallis test in lieu of an ANOVA because of the lack of normality
Cr_bySource <- kruskal(USGS_analyze$Cr_ppm, USGS_analyze$Source, group=TRUE, p.adj = "bonferroni")
Cr_bySource #Chi-sq = 36.008, Df = 4, p < 0.001
#mine-impacted                       863.7895      a
#forested                            585.8810      b
#glacial deposit                     539.7711     bc
#sedge/moss/shrub wetland            535.5665     bc
#tundra                              498.6956      c

#Counts for annotation
Cr_count <- select(USGS_analyze, Source, upper.cm, Depth, Cr_ppm)
Cr_count<- filter(Cr_count, !is.na(Cr_ppm))
Cr_count %>% 
  group_by(Source) %>%
  summarise(no_rows = length(Source))

##Chromium by source boxplot
Cr_plot <- ggplot(USGS_analyze, aes(Source, Cr_log, fill=Source)) + 
  geom_boxplot() +
  xlab("source") +
  ylab("ln [Cr (mg/kg)]") +
  theme_classic()+
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#adds coded colors, number of obs., and post-hoc groups
Cr_plot + 
  scale_fill_manual(values=c("#80b1d3", "#b3de69", "#fdb462", "#fb8072", "#bebada")) + 
  annotate("text", x = 1:5, y = -0.5, label = c("83", "273", "524", "19", "173")) + 
  ylim(-0.5,10) + 
  annotate("text", x = 1:5, y = 10, label = c("bc", "b", "c", "a", "bc"))
#Line values from WHO permissible limits for heavy metals in plant and soil (1996)
# + geom_hline(yintercept=4.605, linetype="dashed", size=0.75) 
# Adds line for US average from US Toxic Substances and Disease Registry
# + geom_hline(yintercept=3.611, linetype="dotted", size=0.75, color="black") 
#Adds group means
#+ stat_summary(fun.y=mean, geom="point", shape=23, size=3, color="black", fill="white") 


#Checking distribution for stats on depth
bartlett.test(Cr_ppm~Depth, data=USGS_analyze) #tests for homogeneity of variance, p = 0.0003218

#Does log transforming help meet assumptions for ANOVA?
bartlett.test(Cr_log~Depth, data=USGS_analyze)#no, p  < 0.001

#using Kruskal-Wallis test in lieu of an ANOVA because of the lack of normality - this has a built in post hoc test using the criterium Fisher's least significant difference
Cr_byDepth <- kruskal(USGS_analyze$Cr_ppm, USGS_analyze$Depth, group=TRUE, p.adj = "bonferroni")
Cr_byDepth #Chi-sq = 47, Df = 2, p <0.001
#mid                632.9935      a
#surface            537.5304      b
#deep               338.6646      c


#getting count for Depth
Cr_count %>% 
 group_by(Depth) %>%
  summarise(no_rows = length(Depth))

#plot by depth
Cr_depth <- ggplot(USGS_analyze, aes(depth, Cr_log, fill=depth)) + 
 geom_boxplot() +
  xlab("source") +
  ylab("ln [Cr (mg/kg)]") +
  theme_classic()+
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

Cr_depth + 
  scale_fill_manual(values=c("#fee6ce", "#fdae6b", "#e6550d")) +
  annotate("text", x = 1:3, y = -0.5, label = c("840", "153", "79")) +
  ylim(-0.5,10) + 
  annotate("text", x = 1:3, y = 10, label = c("b", "a", "c"))
#Line values from WHO permissible limits for heavy metals in plant and soil (1996)
# + geom_hline(yintercept=4.605, linetype="dashed", size=0.75)
# Adds line for US average from US Toxic Substances and Disease Registry
# + geom_hline(yintercept=3.611, linetype="dotted", size=0.75, color="black")
# Adds group means
# + stat_summary(fun.y=mean, geom="point", shape=23, size=3, color="black", fill="white") 


```


Boxplots for Hg
```{r}
#get summary statistics for Hg concentrations
summary(USGS_analyze$Hg_ppm, na.rm=TRUE)
   #Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
   # 0.01    0.04    0.06   30.44    0.09 6090.00     351  
sd(USGS_analyze$Hg_ppm, na.rm=TRUE)
#sd is 277.0058

#Checking distribution
shapiro.test(USGS_analyze$Hg_ppm) #tests for normality, p < 0.001
bartlett.test(Hg_ppm~Source, data=USGS_analyze) #tests for homogeneity of variance, p < 0.001

#Does log transforming help meet assumptions for ANOVA?
shapiro.test(USGS_analyze$Hg_log) #no, p < 0.001
bartlett.test(Hg_log~Source, data=USGS_analyze)#no, p  < 0.001


#using Kruskal-Wallis test in lieu of an ANOVA because of the lack of normality
Hg_bySource <- kruskal(USGS_analyze$Hg_ppm, USGS_analyze$Source, group=TRUE, p.adj = "bonferroni")
Hg_bySource #Chi-sq = 72.28, Df = 4, p < 0.001
#mine-impacted                       791.3333      a
#glacial deposit                     489.8313      b
#tundra                              403.1229      c
#sedge/moss/shrub wetland            398.0912      c
#forested                            297.4919      d

#Counts for annotation
Hg_count <- select(USGS_analyze, Source, Depth, upper.cm, Hg_ppm)
Hg_count<- filter(Hg_count, !is.na(Hg_ppm))
Hg_count %>% 
  group_by(Source) %>%
  summarise(no_rows = length(Source))


##Mercury by source boxplot
Hg_plot <- ggplot(USGS_analyze, aes(Source, Hg_log, fill=Source)) + 
  geom_boxplot() +
  xlab("source") +
  ylab("ln [Hg (mg/kg)]") +
  theme_classic()+
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#adds correct colors, number of obs., and post-hoc groups
Hg_plot + 
  scale_fill_manual(values=c("#80b1d3", "#b3de69", "#fdb462", "#fb8072", "#bebada")) + 
  annotate("text", x = 1:5, y = -6, label = c("83", "124", "411", "12", "170")) + 
  ylim(-6,10) + 
  annotate("text", x = 1:5, y = 10, label = c("b", "d", "c", "a", "c")) 
#Adds a health limit line from the Canadian Council of Ministers (2009)
# + geom_hline(yintercept=1.887, linetype="dashed", size=0.75) 
# Adds a line for average value of soils from W USA (Obrist et al., 2016)
# + geom_hline(yintercept=-3.5404, linetype="dotted", size=0.75, color="black")
#Adds group means
#+ stat_summary(fun.y=mean, geom="point", shape=23, size=3, color="black", fill="white")


#Checking distribution for stats for depth
bartlett.test(Hg_ppm~Depth, data=USGS_analyze) #tests for homogeneity of variance, p < 0.001

#Does log transforming help meet assumptions for ANOVA?
bartlett.test(Hg_log~Depth, data=USGS_analyze)#no, p  < 0.001

#using Kruskal-Wallis test in lieu of an ANOVA because of the lack of normality - this has a built in post hoc test using the criterium Fisher's least significant difference
Hg_byDepth <- kruskal(USGS_analyze$Hg_ppm, USGS_analyze$Depth, group=TRUE, p.adj = "bonferroni")
Hg_byDepth #Chi-sq = 6.68, Df = 2, p = 0.0354
#deep               470.5538      a
#surface            395.6481      b
#mid                388.7917      b

#getting depth counts
Hg_count %>% 
  group_by(Depth) %>%
  summarise(no_rows = length(Depth))

#plot by depth
Hg_depth <- ggplot(USGS_analyze, aes(depth, Hg_log, fill=depth)) + 
 geom_boxplot() +
xlab("source") +
  ylab("ln [Hg (mg/kg)]") +
  theme_classic()+
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#adds correct colors and number of obs. 
Hg_depth + 
  scale_fill_manual(values=c("#e5f5e0", "#a1d99b", "#31a354"))+
  annotate("text", x = 1:3, y = -6, label = c("591", "144", "65")) +
  ylim(-6,10) + 
  annotate("text", x = 1:3, y = 10, label = c("b", "b", "a")) 
#Adds a health limit line from the Canadian Council of Ministers (2009)
# + geom_hline(yintercept=1.887, linetype="dashed", size=0.75) 
# Adds a line for average value of soils from W USA (Obrist et al., 2016)
# + geom_hline(yintercept=-3.5404, linetype="dotted", size=0.75, color="black")
#Adds group means
#+ stat_summary(fun.y=mean, geom="point", shape=23, size=3, color="black", fill="white")

```


Boxplots for Ni
```{r}
#get summary statistics for Ni concentrations
summary(USGS_analyze$Ni_ppm, na.rm=TRUE)
  #Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
    #2.00   19.00   28.30   44.55   41.60  702.00      78
sd(USGS_analyze$Ni_ppm, na.rm=TRUE)
#stavard deviation is 60.97551

#Checking distribution
shapiro.test(USGS_analyze$Ni_ppm) #tests for normality, p < 0.001
bartlett.test(Ni_ppm~Source, data=USGS_analyze) #tests for homogeneity of variance, p < 0.0002

#Does log transforming help meet assumptions for ANOVA?
shapiro.test(USGS_analyze$Ni_log) #no, p < 0.001
bartlett.test(Ni_log~Source, data=USGS_analyze)#no, p  < 0.001

#using Kruskal-Wallis test in lieu of an ANOVA because of the lack of normality
Ni_bySource <- kruskal(USGS_analyze$Ni_ppm, USGS_analyze$Source, group=TRUE, p.adj = "bonferroni")
Ni_bySource #Chi-sq = 140.26, Df = 4, p < 0.001
#mine-impacted                       816.7895      a
#forested                            638.6410      a
#tundra                              553.0659      b
#sedge/moss/shrub wetland            435.2275      c
#glacial deposit                     240.6265      d

##gets counts for annotation
Ni_count <- select(USGS_analyze, Source, Depth, upper.cm, Ni_ppm)
Ni_count<- filter(Ni_count, !is.na(Ni_ppm))
Ni_count %>% 
  group_by(Source) %>%
  summarise(no_rows = length(Source))


##Nickel by source boxplot
Ni_plot <- ggplot(USGS_analyze, aes(Source, Ni_log, fill=Source)) + 
  geom_boxplot() +
  xlab("source") +
  ylab("log [Ni (mg/kg)]") +
  theme_classic()+ 
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#adds correct colors, number of obs., lines for WHO limit/US avg, and post-hoc groups 
Ni_plot + 
  scale_fill_manual(values=c("#80b1d3", "#b3de69", "#fdb462", "#fb8072", "#bebada")) + 
  annotate("text", x = 1:5, y = -10, label = c("83", "273", "531", "19", "167")) +
  ylim(-0.5,10) + 
  annotate("text", x = 1:5, y = 10, label = c("d", "a", "b", "a", "c"))
##Line values from WHO permissible limits for heavy metals in plant and soil (1996)
# +  geom_hline(yintercept=3.555, linetype="dashed", size=0.75)
#Adds a US average from the Toxic Substances and Disease Registry
# + geom_hline(yintercept=3.6888, linetype="dotted", size=0.75, color="black") 
# Adds group means
#+ stat_summary(fun.y=mean, geom="point", shape=23, size=3, color="black", fill="white")

#Checking distribution for stats for depth
bartlett.test(Ni_ppm~Depth, data=USGS_analyze) #tests for homogeneity of variance, p < 0.001

#Does log transforming help meet assumptions for ANOVA?
bartlett.test(Ni_log~Depth, data=USGS_analyze) #no, p < 0.001

#using Kruskal-Wallis test in lieu of an ANOVA because of the lack of normality - this has a built in post hoc test using the criterium Fisher's least significant difference
Ni_byDepth <- kruskal(USGS_analyze$Ni_ppm, USGS_analyze$Depth, group=TRUE, p.adj = "bonferroni")
Ni_byDepth #Chi-sq = 63.37, Df = 2, p < 0.001
#surface            577.1455      a
#mid                402.3758      b
#deep               384.9529      b

#getting depth count
Ni_count %>% 
  group_by(Depth) %>%
  summarise(no_rows = length(Depth))

#depth plot
Ni_depth <- ggplot(USGS_analyze, aes(depth, Ni_log, fill=depth)) + 
  geom_boxplot() +
  xlab("depth") +
  ylab("log [Ni (mg/kg)]") +
  theme_classic()+ 
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#adds correct colors and number of obs. 
Ni_depth + 
  scale_fill_manual(values=c("#deebf7", "#9ecae1","#3182bd")) +
  annotate("text", x = 1:3, y = -10, label = c("835", "153", "85")) +
  ylim(-0.5,10) + 
  annotate("text", x = 1:3, y = 10, label = c("a", "b", "b"))
##Line values from WHO permissible limits for heavy metals in plant and soil (1996)
# +  geom_hline(yintercept=3.555, linetype="dashed", size=0.75)
#Adds a US average from the Toxic Substances and Disease Registry
# + geom_hline(yintercept=3.6888, linetype="dotted", size=0.75, color="black") 
# Adds group means
#+ stat_summary(fun.y=mean, geom="point", shape=23, size=3, color="black", fill="white")
```


Boxplots for Pb
```{r}
#get summary statistics for Hg concentrations
summary(USGS_analyze$Pb_ppm, na.rm=TRUE)
    #Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
   #2.00    9.00   13.00   21.06   19.00  720.00      70 
sd(USGS_analyze$Pb_ppm, na.rm=TRUE)
#stavard deviation is 41.14311


#Checking distrubition
shapiro.test(USGS_analyze$Pb_ppm) #tests for normality, p < 0.001
bartlett.test(Pb_ppm~Source, data=USGS_analyze) #tests for homogeneity of variance, p < 0.001

#Does log transforming help meet assumptions for ANOVA?
shapiro.test(USGS_analyze$Pb_log) #no, p < 0.001
bartlett.test(Pb_log~Source, data=USGS_analyze)#no, p  < 0.001

#using Kruskal-Wallis test in lieu of an ANOVA because of the lack of normality
Pb_bySource <- kruskal(USGS_analyze$Pb_ppm, USGS_analyze$Source, group=TRUE, p.adj = "bonferroni")
Pb_bySource #Chi-sq = 119.91, Df = 4, p < 0.001
#mine-impacted                       885.1579      a
#forested                            580.6905      b
#glacial deposit                     575.9699      b
#tundra                              573.2651      b
#sedge/moss/shrub wetland            317.3114      c

##getting counts for each source type to annotate figure 
Pb_count <- select(USGS_analyze, Source, Depth, upper.cm, Pb_ppm, Pb_log)
Pb_count<- filter(Pb_count, !is.na(Pb_ppm))
Pb_count %>% 
  group_by(Source) %>%
  summarise(no_rows = length(Source))

##Lead by source boxplot
Pb_plot <- ggplot(USGS_analyze, aes(Source, Pb_log, fill=Source)) + 
   geom_boxplot() +
  xlab("source") +
  ylab("log [Pb (mg/kg)]") +
  theme_classic()+
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#adds correct colors, number of obs., lines for WHO limit/US avg, and post-hoc groups 
Pb_plot + scale_fill_manual(values=c("#80b1d3", "#b3de69", "#fdb462", "#fb8072", "#bebada")) + geom_hline(yintercept=4.4426, linetype="dashed", size=0.75) + annotate("text", x = 1:5, y = -0.5, label = c("83", "231", "581", "19", "167"))  + geom_hline(yintercept=3.401, linetype="dotted", size=0.75) + ylim(-0.5,10) + annotate("text", x = 1:5, y = 10, label = c("b", "b", "b", "a", "c"))
##Line values from WHO permissible limits for heavy metals in plant and soil (1996)
#+ stat_summary(fun.y=mean, geom="point", shape=23, size=3, color="black", fill="white") 

#Checking distribution for stats for depth
bartlett.test(Pb_ppm~Depth, data=USGS_analyze) #tests for homogeneity of variance, p < 0.001

#Does log transforming help meet assumptions for ANOVA?
bartlett.test(Pb_log~Depth, data=USGS_analyze) #no, p < 0.001

#using Kruskal-Wallis test in lieu of an ANOVA because of the lack of normality - this has a built in post hoc test using the criterium Fisher's least significant difference
Pb_byDepth <- kruskal(USGS_analyze$Pb_ppm, USGS_analyze$Depth, group=TRUE, p.adj = "bonferroni")
Pb_byDepth #Chi-sq = 11.385, Df = 2, p = 0.0034
#mid                620.0822      a
#surface            528.1214      b
#deep               527.4588      b

#depth counts
Pb_count %>% 
  group_by(Depth) %>%
  summarise(no_rows = length(Depth))

#By depth
Pb_depth <- ggplot(USGS_analyze, aes(depth, Pb_log, fill=depth)) + 
   geom_boxplot() +
  xlab("source") +
  ylab("log [Pb (mg/kg)]") +
  theme_classic()+
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

Pb_depth + scale_fill_manual(values=c("#efedf5", "#bcbddc","#756bb1")) + geom_hline(yintercept=4.4426, linetype="dashed", size=0.75) + annotate("text", x = 1:3, y = -0.5, label = c("844","152","85"))  + geom_hline(yintercept=3.401, linetype="dotted", size=0.75) + ylim(-0.5,10) + annotate("text", x = 1:3, y = 10, label = c("b", "a", "b"))
##Line values from WHO permissible limits for heavy metals in plant and soil (1996)
#+ stat_summary(fun.y=mean, geom="point", shape=23, size=3, color="black", fill="white") 

```
Making figure for % over limits: 
```{r}
#write.csv(USGS_analyze, file ="filteredData_forMaps")
#Calculates the proportion of values greater than the UK Envi Agency As in soil limit (32 mg/kg)
mean(USGS_analyze$As_ppm > 32, na.rm=TRUE)
# returns 0.78 (OLD)
# NEW: 0.1425
#Calculates the proportion of values greater than the US avg for As in soil from the Toxic Substances and Disease Registry (7.2 mg/kg)
mean(USGS_analyze$As_ppm > 7.2, na.rm=TRUE)
# returns 0.885 (OLD)
# NEW: 0.7211

#Calculates the proportion of values greater than the WHO Cr in soil limit (100 mg/kg)
mean(USGS_analyze$Cr_ppm > 100, na.rm=TRUE)
# returns 0.6799 (OLD)
# NEW: 0.09235075
#Calculates the proportion of values greater than the US avg for Cr in soil from the Toxic Substances and Disease Registry (37 mg/kg)
mean(USGS_analyze$Cr_ppm > 37, na.rm=TRUE)
# returns 0.879 (OLD)
#NEW: 0.7014925

#Calculates the proportion of values greater than the Canadian Council of Ministers of the Environment Hg in soil limit (6.6 mg/kg)
mean(USGS_analyze$Hg_ppm > 6.6, na.rm=TRUE)
#returns 0.5479 (OLD)
# NEW: 0.0375
#Calculates the proportion of values greater than the median value for soils in the Western United States (0.029 mg/kg; from Obrist et al., 2016)
mean(USGS_analyze$Hg_ppm > 0.029, na.rm=TRUE)
# returns 0.935

#Calculates the proportion of values greater than the WHO Ni in soil limit (35 mg/kg)
mean(USGS_analyze$Ni_ppm > 35, na.rm=TRUE)
# returns 0.897 (OLD)
# NEW: 0.3522833
#Calculates the proportion of values greater than the US avg for Ni in soil from the Toxic Substances and Disease Registry (40 mg/kg)
mean(USGS_analyze$Ni_ppm > 40, na.rm=TRUE)
# returns 0.876 (OLD)
# NEW: 0.2646785

#Calculates the proportion of values greater than the WHO Pb in soil limit (85 mg/kg)
mean(USGS_analyze$Pb_ppm > 85, na.rm=TRUE)
# returns 0.029 (OLD)
# NEW: 0.02867715
#Calculates the proportion of values greater than the US avg for Pb in soil from the Toxic Substances and Disease Registry (30 mg/kg)
mean(USGS_analyze$Pb_ppm > 30, na.rm=TRUE)
# returns 0.1009
# NEW: 0.1008326

#making a plot of values above health limits: 
#creates a vector of the % of samples above health limits
limits <- c(mean(USGS_analyze$As_ppm > 32, na.rm=TRUE), mean(USGS_analyze$Cr_ppm > 100, na.rm=TRUE), mean(USGS_analyze$Hg_ppm > 6.6, na.rm=TRUE), mean(USGS_analyze$Ni_ppm > 35, na.rm=TRUE), mean(USGS_analyze$Pb_ppm > 85, na.rm=TRUE))

#making a dataframe to add metals names
limits <- as.data.frame(limits)
limits$metals <- c("As", "Cr", "Hg", "Ni", "Pb")
barplot(limits$limits)

#barplot of % over limit - color version for presentations
ggplot(limits, aes(metals, limits, fill=metals)) +
  geom_col(
    aes(x = metals, ymin = 0, ymax = limits))+ ylim(0,1.0)+
    xlab("") +
  ylab("Proprtion Over Human Health Standard") +
  scale_fill_manual(values=c("#de2d26", "#e6550d","#31a354", "#3182bd","#756bb1"))+
  theme_classic()

#greyscale version for manuscript
ggplot(limits, aes(metals, limits, fill=metals)) +
  geom_col(
    aes(x = metals, ymin = 0, ymax = limits))+ ylim(0,1.0)+
    xlab("") +
  ylab("Proprtion Over Human Health Standard") +
  scale_fill_manual(values=c("#d9d9d9", "#bdbdbd","#969696", "#737373","#525252"))+
  theme_classic()


#making a plot of values above US averages: 
#creates a vector of the % of samples above averages
averages <- c(mean(USGS_analyze$As_ppm > 7.2, na.rm=TRUE), mean(USGS_analyze$Cr_ppm > 37, na.rm=TRUE), mean(USGS_analyze$Hg_ppm > 0.029, na.rm=TRUE), mean(USGS_analyze$Ni_ppm > 40, na.rm=TRUE), mean(USGS_analyze$Pb_ppm > 30, na.rm=TRUE))

#making a dataframe to add metals names
averages <- as.data.frame(averages)
averages$metals <- c("As", "Cr", "Hg", "Ni", "Pb")
barplot(averages$averages)

#barplot of % over limit - color version for presentations
ggplot(averages, aes(metals, averages, fill=metals)) +
  geom_col(
    aes(x = metals, ymin = 0, ymax = averages))+ ylim(0,1.0)+
    xlab("") +
  ylab("Proprtion Above US Averages") +
  scale_fill_manual(values=c("#de2d26", "#e6550d","#31a354", "#3182bd","#756bb1"))+
  theme_classic()

#greyscale version for manuscript
ggplot(averages, aes(metals, averages, fill=metals)) +
  geom_col(
    aes(x = metals, ymin = 0, ymax = averages))+ ylim(0,1.0)+
    xlab("") +
  ylab("Proprtion Above US Averages") +
  scale_fill_manual(values=c("#d9d9d9", "#bdbdbd","#969696", "#737373","#525252"))+
  theme_classic()



```




Depth loop...still in process. 

```{r}
#Can't get this to work yet...I think something is wrong with the UPPER column? It says it's numeric...but it won't perform any mathematical operations on the column. 

#> USGS5$UPPER
#NULL
#> as.numeric(USGS5$UPPER)
#numeric(0)


###should work in theory...doesn't
converted <- mutate(USGS5, TOP = 
        ifelse(grepl("in", UNIT), USGS5$UPPER*2.54,
        ifelse(grepl("ft", UNIT), USGS5$UPPER*30.48, USGS5$UPPER*1))


###should work in theory...doesn't
USGS5$TOP <- ifelse(USGS5$UNIT %in% "in", USGS5$UPPER*2.54, USGS5$UPPER*1, 
ifelse(USGS5$UNIT %in% "ft", USGS5$UPPER*30.48, USGS5$UPPER*1))


```


